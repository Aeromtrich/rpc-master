ğŸ“‹ ä¸€ã€å¯åŠ¨æµç¨‹è¯¦è§£

1.1 è§¦å‘æ—¶æœº

å¯åŠ¨æµç¨‹åœ¨ é¦–æ¬¡è®¿é—® SerializerFactory ç±»æ—¶è§¦å‘ï¼Œè¿™æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„ç‰¹æ€§ã€‚

// ä»»ä½•é¦–æ¬¡ä½¿ç”¨ SerializerFactory çš„ä»£ç éƒ½ä¼šè§¦å‘ç±»åŠ è½½
SerializerFactory.getInstance("jdk");  // é¦–æ¬¡è°ƒç”¨

1.2 ç±»åŠ è½½é˜¶æ®µ

å½“ JVM é¦–æ¬¡åŠ è½½ SerializerFactory ç±»æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

public class SerializerFactory {

      // â­ æ­¥éª¤1ï¼šJVM åŠ è½½ç±»æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œ static å—
      static {
          SpiLoader.load(Serializer.class);  // è°ƒç”¨ SPI åŠ è½½å™¨
      }

      // â­ æ­¥éª¤2ï¼šåˆå§‹åŒ–é™æ€å¸¸é‡ï¼ˆè¿™ä¸ªå®é™…ä¸Šæ²¡è¢«ä½¿ç”¨ï¼‰
      private static final Serializer DEFAULT_SERIALIZER = new JdkSerializer();
}

1.3 SPI åŠ è½½è¯¦ç»†æµç¨‹

è®©æˆ‘ç”¨å›¾ç¤ºå’Œä»£ç è¯¦ç»†è¯´æ˜ SpiLoader.load(Serializer.class) çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

æ­¥éª¤ 1ï¼šåˆå§‹åŒ–æ•°æ®ç»“æ„

// SpiLoader.java:104-107
public static Map<String, Class<?>> load(Class<?> loadClass) {
log.info("åŠ è½½ç±»å‹ä¸º {} çš„ SPI", loadClass.getName());
// åˆ›å»ºä¸´æ—¶ Map å­˜å‚¨ key -> Class æ˜ å°„
Map<String, Class<?>> keyClassMap = new HashMap<>();

æ­¤æ—¶å†…å­˜çŠ¶æ€ï¼š
keyClassMap = {}  // ç©ºçš„ HashMap
loadClass = Serializer.class

æ­¥éª¤ 2ï¼šæ‰«æé…ç½®æ–‡ä»¶ç›®å½•

// SpiLoader.java:108-109
for (String scanDir : SCAN_DIRS) {
List<URL> resources = ResourceUtil.getResources(scanDir + loadClass.getName());

æ‰«æè·¯å¾„ï¼š
ç¬¬1æ¬¡å¾ªç¯ï¼šMETA-INF/rpc/system/com.yupi.yurpc.serializer.Serializer
ç¬¬2æ¬¡å¾ªç¯ï¼šMETA-INF/rpc/custom/com.yupi.yurpc.serializer.Serializer

Hutool çš„ ResourceUtil.getResources() åšäº†ä»€ä¹ˆï¼Ÿ
- ä½¿ç”¨ ClassLoader.getResources() æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„èµ„æºæ–‡ä»¶
- è¿”å› List<URL>ï¼ŒåŒ…å«æ‰€æœ‰æ‰¾åˆ°çš„æ–‡ä»¶è·¯å¾„
- æ”¯æŒä» JAR åŒ…å’Œæ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾

æ­¥éª¤ 3ï¼šè¯»å–é…ç½®æ–‡ä»¶å†…å®¹

// SpiLoader.java:111-123
for (URL resource : resources) {
try {
InputStreamReader inputStreamReader = new InputStreamReader(resource.openStream());
BufferedReader bufferedReader = new BufferedReader(inputStreamReader);
String line;
while ((line = bufferedReader.readLine()) != null) {
String[] strArray = line.split("=");
if (strArray.length > 1) {
String key = strArray[0];
String className = strArray[1];
keyClassMap.put(key, Class.forName(className));
}
}
} catch (Exception e) {
log.error("spi resource load error", e);
}
}

é€è¡Œè§£æé…ç½®æ–‡ä»¶ï¼š

å‡è®¾è¯»å–åˆ°çš„æ–‡ä»¶å†…å®¹æ˜¯ï¼š
jdk=com.yupi.yurpc.serializer.JdkSerializer
hessian=com.yupi.yurpc.serializer.HessianSerializer
json=com.yupi.yurpc.serializer.JsonSerializer
kryo=com.yupi.yurpc.serializer.KryoSerializer

è§£æè¿‡ç¨‹ï¼š
å¾ªç¯æ¬¡æ•°: 1
line å†…å®¹: jdk=com.yupi.yurpc.serializer.JdkSerializer
split ç»“æœ: ["jdk", "com.yupi.yurpc.serializer.JdkSerializer"]
key: jdk
className: com.yupi.yurpc.serializer.JdkSerializer
æ“ä½œ: Class.forName() åŠ è½½ç±»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¾ªç¯æ¬¡æ•°: 2
line å†…å®¹: hessian=com.yupi.yurpc.serializer.HessianSerializer
split ç»“æœ: ["hessian", "com.yupi.yurpc.serializer.HessianSerializer"]
key: hessian
className: com.yupi.yurpc.serializer.HessianSerializer
æ“ä½œ: Class.forName() åŠ è½½ç±»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¾ªç¯æ¬¡æ•°: 3
line å†…å®¹: json=com.yupi.yurpc.serializer.JsonSerializer
split ç»“æœ: ["json", "com.yupi.yurpc.serializer.JsonSerializer"]
key: json
className: com.yupi.yurpc.serializer.JsonSerializer
æ“ä½œ: Class.forName() åŠ è½½ç±»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¾ªç¯æ¬¡æ•°: 4
line å†…å®¹: kryo=com.yupi.yurpc.serializer.KryoSerializer
split ç»“æœ: ["kryo", "com.yupi.yurpc.serializer.KryoSerializer"]
key: kryo
className: com.yupi.yurpc.serializer.KryoSerializer
æ“ä½œ: Class.forName() åŠ è½½ç±»
Class.forName() çš„ä½œç”¨ï¼š
- åŠ¨æ€åŠ è½½ç±»åˆ° JVM
- è¿”å› Class<?> å¯¹è±¡ï¼ˆç±»çš„å…ƒæ•°æ®ï¼‰
- æ³¨æ„ï¼šæ­¤æ—¶åªæ˜¯åŠ è½½ç±»ï¼Œå¹¶æœªåˆ›å»ºå®ä¾‹

æ­¥éª¤ 4ï¼šå­˜å‚¨åˆ° loaderMap

// SpiLoader.java:129
loaderMap.put(loadClass.getName(), keyClassMap);

æ­¤æ—¶ loaderMap çš„å†…å­˜ç»“æ„ï¼š

loaderMap = {
"com.yupi.yurpc.serializer.Serializer" -> {
"jdk"     -> Class<JdkSerializer>,
"hessian" -> Class<HessianSerializer>,
"json"    -> Class<JsonSerializer>,
"kryo"    -> Class<KryoSerializer>
}
}

æ•°æ®ç»“æ„å¯è§†åŒ–ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        loaderMap                             â”‚
â”‚  (ConcurrentHashMap<String, Map<String, Class<?>>>)         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Key: "com.yupi.yurpc.serializer.Serializer"                  â”‚
  â”‚ Value: HashMap<String, Class<?>>                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ "jdk"     -> Class<JdkSerializer>                   â”‚   â”‚
â”‚   â”‚ "hessian" -> Class<HessianSerializer>               â”‚   â”‚
â”‚   â”‚ "json"    -> Class<JsonSerializer>                  â”‚   â”‚
â”‚   â”‚ "kryo"    -> Class<KryoSerializer>                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1.4 å¯åŠ¨æµç¨‹æ€»ç»“

å®Œæ•´æ—¶åºå›¾ï¼š

JVM å¯åŠ¨
â”‚
â”œâ”€> é¦–æ¬¡è®¿é—® SerializerFactory ç±»
â”‚      â”‚
â”‚      â”œâ”€> æ‰§è¡Œ static å—
â”‚      â”‚      â”‚
â”‚      â”‚      â””â”€> SpiLoader.load(Serializer.class)
â”‚      â”‚             â”‚
â”‚      â”‚             â”œâ”€> åˆ›å»º keyClassMap = new HashMap<>()
â”‚      â”‚             â”‚
â”‚      â”‚             â”œâ”€> æ‰«æ META-INF/rpc/system/
â”‚      â”‚             â”‚      â”‚
â”‚      â”‚             â”‚      â””â”€> æ‰¾åˆ°é…ç½®æ–‡ä»¶
â”‚      â”‚             â”‚             â”‚
â”‚      â”‚             â”‚             â”œâ”€> æ‰“å¼€æ–‡ä»¶æµ
â”‚      â”‚             â”‚             â”œâ”€> é€è¡Œè¯»å–
â”‚      â”‚             â”‚             â”œâ”€> split("=") åˆ†å‰²
â”‚      â”‚             â”‚             â”œâ”€> Class.forName() åŠ è½½ç±»
â”‚      â”‚             â”‚             â””â”€> put åˆ° keyClassMap
â”‚      â”‚             â”‚
â”‚      â”‚             â”œâ”€> æ‰«æ META-INF/rpc/custom/
â”‚      â”‚             â”‚      â”‚
â”‚      â”‚             â”‚      â””â”€> ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰é…ç½®ï¼Œè¦†ç›–ç³»ç»Ÿé…ç½®ï¼‰
â”‚      â”‚             â”‚
â”‚      â”‚             â””â”€> loaderMap.put(æ¥å£å, keyClassMap)
â”‚      â”‚
â”‚      â””â”€> åˆå§‹åŒ– DEFAULT_SERIALIZER = new JdkSerializer()
â”‚
â””â”€> å¯åŠ¨å®Œæˆï¼Œç­‰å¾…è¿è¡Œæ—¶è°ƒç”¨

  ---
ğŸš€ äºŒã€è¿è¡Œæ—¶è·å–è¯¦è§£

2.1 è§¦å‘æ—¶æœº

è¿è¡Œæ—¶è·å–å‘ç”Ÿåœ¨éœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ–æ•°æ®æ—¶ï¼š

// ç¤ºä¾‹ï¼šåè®®æ¶ˆæ¯ç¼–ç å™¨ä¸­
Serializer serializer = SerializerFactory.getInstance("json");
byte[] bytes = serializer.serialize(rpcRequest);

2.2 getInstance() æ‰§è¡Œæµç¨‹

æ­¥éª¤ 1ï¼šè°ƒç”¨ SerializerFactory.getInstance()

// SerializerFactory.java:27-29
public static Serializer getInstance(String key) {
return SpiLoader.getInstance(Serializer.class, key);
}

å‚æ•°ä¼ é€’ï¼š
key = "json"
tClass = Serializer.class

æ­¥éª¤ 2ï¼šè¿›å…¥ SpiLoader.getInstance()

// SpiLoader.java:74-76
public static <T> T getInstance(Class<?> tClass, String key) {
      String tClassName = tClass.getName();
      Map<String, Class<?>> keyClassMap = loaderMap.get(tClassName);

æ‰§è¡Œç»†èŠ‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ â”‚           ä»£ç             â”‚                    å€¼                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ tClass.getName()          â”‚ "com.yupi.yurpc.serializer.Serializer"   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2    â”‚ loaderMap.get(tClassName) â”‚ è¿”å›ä¹‹å‰åŠ è½½çš„ HashMap<String, Class<?>> â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ­¤æ—¶ keyClassMap çš„å€¼ï¼š
keyClassMap = {
"jdk"     -> Class<JdkSerializer>,
"hessian" -> Class<HessianSerializer>,
"json"    -> Class<JsonSerializer>,
"kryo"    -> Class<KryoSerializer>
}

æ­¥éª¤ 3ï¼šæ ¡éªŒ loaderMap æ˜¯å¦å·²åŠ è½½

// SpiLoader.java:77-79
if (keyClassMap == null) {
throw new RuntimeException(String.format("SpiLoader æœªåŠ è½½ %s ç±»å‹", tClassName));
}

æ ¡éªŒé€»è¾‘ï¼š
- å¦‚æœ keyClassMap == nullï¼Œè¯´æ˜å¯åŠ¨æ—¶æœªåŠ è½½è¯¥æ¥å£çš„ SPI é…ç½®
- æŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºå¼€å‘è€…éœ€è¦åœ¨ static å—ä¸­è°ƒç”¨ SpiLoader.load()

æ­¥éª¤ 4ï¼šæ ¡éªŒ key æ˜¯å¦å­˜åœ¨

// SpiLoader.java:80-82
if (!keyClassMap.containsKey(key)) {
throw new RuntimeException(String.format("SpiLoader çš„ %s ä¸å­˜åœ¨ key=%s çš„ç±»å‹", tClassName, key));
}

æ ¡éªŒé€»è¾‘ï¼š
- å¦‚æœé…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰ json=... è¿™ä¸€è¡Œ
- æŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºå¼€å‘è€…è¯¥ key ä¸å­˜åœ¨

æ­¥éª¤ 5ï¼šè·å–å®ç°ç±»çš„ Class å¯¹è±¡

// SpiLoader.java:83-84
Class<?> implClass = keyClassMap.get(key);

æ‰§è¡Œç»“æœï¼š
implClass = Class<JsonSerializer>  // ç±»çš„å…ƒæ•°æ®å¯¹è±¡

æ­¥éª¤ 6ï¼šè·å–å®ç°ç±»çš„å…¨é™å®šå

// SpiLoader.java:85-86
String implClassName = implClass.getName();

æ‰§è¡Œç»“æœï¼š
implClassName = "com.yupi.yurpc.serializer.JsonSerializer"

æ­¥éª¤ 7ï¼šæ£€æŸ¥å®ä¾‹ç¼“å­˜ï¼ˆå•ä¾‹æ¨¡å¼æ ¸å¿ƒï¼‰

// SpiLoader.java:87-94
if (!instanceCache.containsKey(implClassName)) {
try {
instanceCache.put(implClassName, implClass.newInstance());
} catch (InstantiationException | IllegalAccessException e) {
String errorMsg = String.format("%s ç±»å®ä¾‹åŒ–å¤±è´¥", implClassName);
throw new RuntimeException(errorMsg, e);
}
}

ç¼“å­˜é€»è¾‘è¯¦è§£ï¼š

é¦–æ¬¡è°ƒç”¨ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼š
instanceCache.containsKey("com.yupi.yurpc.serializer.JsonSerializer")
-> false

æ‰§è¡Œï¼š
implClass.newInstance()  // åå°„åˆ›å»ºå®ä¾‹
-> new JsonSerializer()  // è°ƒç”¨æ— å‚æ„é€ å‡½æ•°

     instanceCache.put("com.yupi.yurpc.serializer.JsonSerializer", jsonSerializerInstance)

ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ï¼š
instanceCache.containsKey("com.yupi.yurpc.serializer.JsonSerializer")
-> true

è·³è¿‡å®ä¾‹åŒ–ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜

instanceCache çš„å†…å­˜ç»“æ„ï¼š

instanceCache = {
"com.yupi.yurpc.serializer.JsonSerializer" -> JsonSerializer@1a2b3c4d,
"com.yupi.yurpc.serializer.JdkSerializer"  -> JdkSerializer@5e6f7g8h,
...
}

æ­¥éª¤ 8ï¼šè¿”å›å®ä¾‹

// SpiLoader.java:95
return (T) instanceCache.get(implClassName);

ç±»å‹è½¬æ¢ï¼š
Object cachedInstance = instanceCache.get("com.yupi.yurpc.serializer.JsonSerializer");
return (Serializer) cachedInstance;  // å¼ºåˆ¶ç±»å‹è½¬æ¢

2.3 è¿è¡Œæ—¶è·å–æµç¨‹å›¾

SerializerFactory.getInstance("json")
â”‚
â”œâ”€> SpiLoader.getInstance(Serializer.class, "json")
â”‚      â”‚
â”‚      â”œâ”€> tClassName = "com.yupi.yurpc.serializer.Serializer"
â”‚      â”‚
â”‚      â”œâ”€> keyClassMap = loaderMap.get(tClassName)
â”‚      â”‚      â”‚
â”‚      â”‚      â””â”€> è¿”å› {"jdk"->Class, "json"->Class, ...}
â”‚      â”‚
â”‚      â”œâ”€> æ ¡éªŒ keyClassMap != null âœ“
â”‚      â”‚
â”‚      â”œâ”€> æ ¡éªŒ keyClassMap.containsKey("json") âœ“
â”‚      â”‚
â”‚      â”œâ”€> implClass = keyClassMap.get("json")
â”‚      â”‚      â”‚
â”‚      â”‚      â””â”€> Class<JsonSerializer>
â”‚      â”‚
â”‚      â”œâ”€> implClassName = "com.yupi.yurpc.serializer.JsonSerializer"
â”‚      â”‚
â”‚      â”œâ”€> æ£€æŸ¥ instanceCache.containsKey(implClassName)
â”‚      â”‚      â”‚
â”‚      â”‚      â”œâ”€> falseï¼ˆé¦–æ¬¡è°ƒç”¨ï¼‰
â”‚      â”‚      â”‚      â”‚
â”‚      â”‚      â”‚      â”œâ”€> implClass.newInstance()
â”‚      â”‚      â”‚      â”‚      â”‚
â”‚      â”‚      â”‚      â”‚      â””â”€> new JsonSerializer()
â”‚      â”‚      â”‚      â”‚
â”‚      â”‚      â”‚      â””â”€> instanceCache.put(implClassName, instance)
â”‚      â”‚      â”‚
â”‚      â”‚      â””â”€> trueï¼ˆåç»­è°ƒç”¨ï¼‰
â”‚      â”‚             â”‚
â”‚      â”‚             â””â”€> ç›´æ¥ä½¿ç”¨ç¼“å­˜
â”‚      â”‚
â”‚      â””â”€> return (Serializer) instanceCache.get(implClassName)
â”‚
â””â”€> è¿”å› JsonSerializer å®ä¾‹

2.4 æ€§èƒ½ä¼˜åŒ–åˆ†æ

å•ä¾‹æ¨¡å¼çš„ä¼˜åŠ¿ï¼š

// å‡è®¾æœ‰ 1000 æ¬¡ RPC è°ƒç”¨ï¼Œæ¯æ¬¡éƒ½éœ€è¦åºåˆ—åŒ–å™¨

// âŒ æ²¡æœ‰ç¼“å­˜ï¼ˆæ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹ï¼‰
for (int i = 0; i < 1000; i++) {
Serializer s = new JsonSerializer();  // åˆ›å»º 1000 ä¸ªå¯¹è±¡
s.serialize(data);
}
// å†…å­˜å ç”¨ï¼š1000 ä¸ª JsonSerializer å¯¹è±¡
// GC å‹åŠ›ï¼šé«˜

// âœ… ä½¿ç”¨ç¼“å­˜ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
for (int i = 0; i < 1000; i++) {
Serializer s = SerializerFactory.getInstance("json");  // åªåˆ›å»º 1 ä¸ªå¯¹è±¡
s.serialize(data);
}
// å†…å­˜å ç”¨ï¼š1 ä¸ª JsonSerializer å¯¹è±¡
// GC å‹åŠ›ï¼šä½

ConcurrentHashMap çš„çº¿ç¨‹å®‰å…¨ï¼š

// å¤šçº¿ç¨‹å¹¶å‘è°ƒç”¨
Thread 1: SerializerFactory.getInstance("json")
Thread 2: SerializerFactory.getInstance("kryo")
Thread 3: SerializerFactory.getInstance("json")

// ConcurrentHashMap ä¿è¯ï¼š
// 1. è¯»æ“ä½œæ— é”ï¼Œæ€§èƒ½é«˜
// 2. å†™æ“ä½œåˆ†æ®µé”ï¼Œå¹¶å‘åº¦é«˜
// 3. ä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´

  ---
ğŸ¯ ä¸‰ã€å®Œæ•´è°ƒç”¨ç¤ºä¾‹

3.1 å®é™…ä»£ç è°ƒç”¨

// åè®®æ¶ˆæ¯ç¼–ç å™¨ä¸­çš„å®é™…è°ƒç”¨
public static Buffer encode(ProtocolMessage<?> protocolMessage) throws IOException {
// 1. ä»åè®®å¤´è·å–åºåˆ—åŒ–å™¨ç±»å‹ï¼ˆå­—èŠ‚å€¼ï¼‰
byte serializerKey = header.getSerializer();  // å‡è®¾å€¼ä¸º 2

      // 2. è½¬æ¢ä¸ºå­—ç¬¦ä¸² key
      ProtocolMessageSerializerEnum serializerEnum =
          ProtocolMessageSerializerEnum.getEnumByKey(serializerKey);
      String serializerName = serializerEnum.getValue();  // "json"

      // 3. è·å–åºåˆ—åŒ–å™¨å®ä¾‹ï¼ˆè§¦å‘è¿è¡Œæ—¶è·å–æµç¨‹ï¼‰
      Serializer serializer = SerializerFactory.getInstance(serializerName);

      // 4. ä½¿ç”¨åºåˆ—åŒ–å™¨
      byte[] bodyBytes = serializer.serialize(protocolMessage.getBody());

      return buffer;
}

3.2 å†…å­˜çŠ¶æ€å˜åŒ–

é¦–æ¬¡è°ƒç”¨ getInstance("json")ï¼š

è°ƒç”¨å‰ï¼š
loaderMap = {"com.yupi.yurpc.serializer.Serializer" -> {...}}
instanceCache = {}

è°ƒç”¨åï¼š
loaderMap = {"com.yupi.yurpc.serializer.Serializer" -> {...}}
instanceCache = {"com.yupi.yurpc.serializer.JsonSerializer" -> JsonSerializer@1a2b}

ç¬¬äºŒæ¬¡è°ƒç”¨ getInstance("json")ï¼š

è°ƒç”¨å‰ï¼š
instanceCache = {"com.yupi.yurpc.serializer.JsonSerializer" -> JsonSerializer@1a2b}

è°ƒç”¨åï¼š
instanceCache = {"com.yupi.yurpc.serializer.JsonSerializer" -> JsonSerializer@1a2b}
ï¼ˆç›´æ¥è¿”å›ç¼“å­˜ï¼Œæ— æ–°å¯¹è±¡åˆ›å»ºï¼‰

  ---
ğŸ“Š å››ã€å…³é”®è®¾è®¡æ€»ç»“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®¾è®¡ç‚¹   â”‚                  å®ç°æ–¹å¼                  â”‚            ä¼˜åŠ¿            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‡’åŠ è½½     â”‚ ç±»åŠ è½½æ—¶åªåŠ è½½ Classï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶æ‰åˆ›å»ºå®ä¾‹ â”‚ èŠ‚çœå¯åŠ¨æ—¶é—´å’Œå†…å­˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•ä¾‹æ¨¡å¼   â”‚ instanceCache ç¼“å­˜å®ä¾‹                     â”‚ é¿å…é‡å¤åˆ›å»ºï¼Œå‡å°‘ GC å‹åŠ› â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çº¿ç¨‹å®‰å…¨   â”‚ ConcurrentHashMap                          â”‚ æ”¯æŒé«˜å¹¶å‘è®¿é—®             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒç›®å½•æ‰«æ â”‚ å…ˆç³»ç»Ÿåè‡ªå®šä¹‰ï¼Œè‡ªå®šä¹‰è¦†ç›–ç³»ç»Ÿ             â”‚ æ”¯æŒæ‰©å±•å’Œå®šåˆ¶             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼‚å¸¸å¤„ç†   â”‚ æ˜ç¡®çš„å¼‚å¸¸æç¤º                             â”‚ ä¾¿äºè°ƒè¯•å’Œæ’æŸ¥é—®é¢˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
è¿™å°±æ˜¯ yu-rpc-core åºåˆ—åŒ– SPI æœºåˆ¶çš„å¯åŠ¨æµç¨‹å’Œè¿è¡Œæ—¶è·å–çš„å®Œæ•´ç»†èŠ‚ï¼